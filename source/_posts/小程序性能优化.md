---
title: 小程序性能优化
date: 2018-08-22 15:31:36
tags: [微信小程序]
---
## 性能问题体现
1. 首屏白屏时间长
2. 加载loading时间长
3. 操作反馈慢（点击，滑动）

## 优化方向
+ 启动加载性能 -->  问题1、2 <br><!--more-->
+ 渲染性能 --> 问题3

## 启动加载性能

### 小程序加载顺序

1. 微信环境初始化小程序环境， 为小程序启动做准备
2. 下载小程序包
3. 业务代码注入，渲染首屏
4. 落地页数据请求

+ 第一, 下载小程序包的时候微信为小程序展示的固定的启动页面， 显示小程序图标、名称、加载提示
+ 第二， 业务代码注入过程，将下载完成的小程序包注入到执行环境，开始编译
+ 落地页数据请求，针对部分小程序首评数据需要异步加载

### 启动加载性能优化
初始化小程序环境是微信环境做的工作，我们无能为力。 除此之外，下载小程序包是主要的性能影响点，毫无疑问，包的大小与下载耗时成正相关，因此对应的优化点应该放在控制小程序包的大小上.

+ 勾选开发者工具中， `上传时压缩代码`
+ 及时清理无用的资源（js文件、图片、demo页面等）
+ 减少本地图片数量，最好使用网络图片，不使用过大的图片
+ 分包加载， 初始化时只加载首评相关、高频访问的资源，其他的按需加载


### 首屏加载其他优化点

除了包大小之外，还可以做一下工作，优化等待体验

1. 提前做异步请求，页面最好在`onLoad`时异步请求数据，不要在`onReady`时请求
2. 缓存数据，请求时先展示缓存内容，让页面尽快展示，请求到最新数据之后再刷新
3. 避免白屏，使用骨架屏等
4. 操作反馈要明显

## 渲染优化

小程序启动成功之后，之后的页面重渲染大多数是由页面数据更新引起的，因此渲染性能问题主要跟`setData`方法有关, 正确的使用`setData`可以有效避免渲染性能问题

### setData 的本质

小程序 视图层是使用webview作为渲染载体， 逻辑层是独立的JavascriptCore作为运行环境。两者是独立的，并不具备数据共享能力。 简言之，每次数据更新，都需要做一次线程间的通信。 因此不正确的使用setData往往会产生性能问题。

1. 数据量， 数据量的大小与耗时成正相关， 不要传输过大的数据
2. 调用频率，setData会引起页面重新渲染，高频率的调用setData，会阻塞页面其他用户交互。 可以合并相关的数据更新
3. setData 只托管与页面渲染有关的数据，不要用来函数间共享数据。 其他与页面渲染无关的数据可以直接挂载载page对象上，即this上，不要挂载在this.data上
4. 不要在后台页面中进行setData操作， 会影响前台页面性能，后台的页面数据更新可以放在该页面进入前台的时候做

除此之外， 事件的绑定也是一次进程间的通信，也会影响到性能，

5. 事件使用不当
  + 删除无用的事件绑定，不要绑定了一个事件，然后在js中写一个空函数
  + 绑定事件时，如果在节点上使用了`data-`的自定义属性，传递数据， 不要传递大体量的数据

6. 页面方法`onPageScroll`使用， 每次页面滚动都会触发，避免在里面写过于复杂的逻辑
7. 节点监控建议使用 节点布局相交状态监听`IntersectionObserver`， 避免频繁的查询节点信息`SelectQuery`

8. 使用自定义组件，自定义组件自成独立的逻辑空间，不会影响页面其他元素， 有自己独立的setData调用。